import requests
from Node import Node
from get_CWE_methods import prettify_scrapeout

def get_CWE_graph(scrapeOut):
    url = 'https://cwe.mitre.org/data/definitions/1000.html'
    page = requests.get(url)
    prettify_scrapeout(page, scrapeOut)

def get_cwe_nodes(scrapeOut):
    abstraction_delim = '"tip"'
    abstraction_flag = False
    id_delim = '<a href="/data/definitions/'
    name_flag = False

    g = Graph()
    node = g.Node()

    with open(scrapeOut, 'r') as f:
        for line in f:
            if abstraction_delim in line:
                abstraction_flag = True
                continue
            if abstraction_flag:
                abstraction = line.split(' - ')[0]
                node.abstraction = abstraction
                abstraction_flag = False
                continue
            if id_delim in line:
                cwe_id = line.split(id_delim)[1]
                cwe_id = cwe_id.split('.')[0]
                try:
                    cwe_id = int(cwe_id)
                except Exception as e:
                    print(f'CWE {cwe_id} cannot be converted to int. Error: {e}')
                    pass
                node.id = cwe_id
                name_flag = True
                continue
            if name_flag:
                node.name = line # check this strips white spaces
                name_flag = False

            
# get_CWE_graph('./data/CWE/scrapeOut.txt')
