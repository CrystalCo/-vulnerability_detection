import os

def getTypeIds(slicepath, totalSamples=None):
    """
        Extracts the vulnerability type ID from the slice titles. 
        Opens all source code files, extracts filenamesper slice for given sample size (for testing), and keeps track of filenames that omit the CWE/CVE ID."
    """
    IDs = []
    nonIDs = []
    for filename in os.listdir(slicepath):
        if (filename.endswith(".txt") is False):
            continue
        filepath = os.path.join(slicepath, filename)
        f1 = open(filepath)
        slicelists = f1.read().split("------------------------------")
        f1.close()

        if slicelists[0] == '':
            del slicelists[0]
        if slicelists[-1] == '' or slicelists[-1] == '\n' or slicelists[-1] == '\r\n':
            del slicelists[-1]

        # if (totalSamples is None):
            # run on all slices

        type_count = 0
        na_count = 0
        total_count = 0
        for slicelist in slicelists:
            # run on sample size specified 
            if total_count == totalSamples:
                break
            total_count += 1
            sentences = slicelist.split('\n')
            if sentences[0] == '\r' or sentences[0] == '':
                del sentences[0]
            if sentences == []:
                continue
            if sentences[-1] == '':
                del sentences[-1]
            if sentences[-1] == '\r':
                del sentences[-1]
            title = sentences[0].split(" ")[1].split("/")[1]
            # some have IDs, some don't
            # for example, 56327 151098/ffmpeg.c memset 344 doesn't have a CWE || CVE id in it.
            if ('CWE' in title):
                type_count += 1
                id_types = title.split('__')
                for id_type in id_types:
                    split_title = id_type.split("_")
                    weakness_id = filter(lambda x: 'CWE' in x, split_title)
                    if (weakness_id):
                        IDs.append(weakness_id)
            if ('CWE' not in title and 'CVE' not in title):
                na_count += 1
                nonIDs.append(title)

        print(f'Filename: {filename}')
        print(f'Slice titles with CWE/CVE IDs included: {type_count}')
        print(f'CWE/CVE IDs: {IDs}')
        print(f'Slice titles with CWE/CVE IDs excluded: {na_count}')
        print(f'Titles excluding CWE/CVE IDs: {nonIDs}')
        print(f'Total slices extracted: {total_count} \n')

def test_getTypeIds():
    slicePath = './data/slicesSource/'
    totalSamples = 4
    getTypeIds(slicePath, totalSamples)

test_getTypeIds()
