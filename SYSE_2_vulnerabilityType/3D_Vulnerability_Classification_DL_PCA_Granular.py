#!/usr/bin/env python
# coding: utf-8

import gc, os, sys

import numpy as np

VUL_PATH = os.environ.get('VUL_PATH')
sys.path.insert(1, VUL_PATH)

from SYSE_1_isVulnerable.preprocess_dl_Input_version5 import process_sequences_shape
from SYSE_2_vulnerabilityType.DetectVulType import DetectVulType
from utils.DLCustomModels import create_bgru_model, create_blstm_model
from utils.MLMethods import convert_nested_lists_to_numpy_arrays, fit_transform_PCA, test_and_get_n_for_PCA
from utils.utils import flatten_categories, getDataset, save_data_to_file

################################## PCA on full dataset (Granular IDs) #############################
############################################ SET UP ############################################
# ## W2V + BGRU Granular
print('Starting PCA script for W2V & BGRU granular ids for 60 epochs...')
RANDOMSEED = 1099
CLASS_TYPE = '157Granular_PCA'
MODEL_TYPE = 'bgru'
VECTOR_TRANSFORMER='w2v'
OPTIMIZER = 'adam'
LAYERS = 2
DROPOUT = 0.2
BATCHSIZE = 64
EPOCHS = 60

vectorRootPath = os.path.join('data','DLvectors')
pca_vectors_train_path = os.path.join(vectorRootPath, 'PCA_train_157classes')
pca_vectors_test_path = os.path.join(vectorRootPath, 'PCA_test_157classes')
dlInputs = os.path.join('data', 'DLinputs')
pca_inputs_train_path = os.path.join(dlInputs,'PCA_train_157classes')
pca_inputs_test_path = os.path.join(dlInputs,'PCA_test_157classes')

checkpoint_dir = './ckpt_%s_%s_%s_%s' % (VECTOR_TRANSFORMER, MODEL_TYPE, str(BATCHSIZE), CLASS_TYPE)
model_name = '%s_%s_batch=%s_seed=%s_epochs=%s_%s' % (MODEL_TYPE.upper(), VECTOR_TRANSFORMER.upper(), BATCHSIZE, RANDOMSEED, EPOCHS, CLASS_TYPE)
metrics_path = os.path.join(f'{VECTOR_TRANSFORMER}Model', 'metrics', MODEL_TYPE)
weights_path = os.path.join('model', model_name + 'weights')

dvt = DetectVulType(build_model=create_bgru_model, useGenerator=True, layers=LAYERS,
                    metricsPath=metrics_path, randomSeed=RANDOMSEED,
                    m_epochs=EPOCHS, batch_size=BATCHSIZE, modelName=model_name,
                    mask=False, dropout=DROPOUT, optimizer=OPTIMIZER,
                    vectorTrainPath=pca_vectors_train_path, vectorTestPath=pca_vectors_test_path, 
                    inputsTrainPath=pca_inputs_train_path, inputsTestPath=pca_inputs_test_path, 
                    checkpoint_dir=checkpoint_dir, weightpath=weights_path)

data = getDataset(dvt.inputsTestPath)
VECTOR_SIZE = len(data[-2])
dvt.vector_size = VECTOR_SIZE
del data
gc.collect()

dvt.avg = 1
dvt.encodeLabels()
print(f'Density units: {dvt.density_units}. Vector size: {dvt.vector_size}')
dvt.reset_check_weights(weights_path)
dvt.build_and_fit()
dvt.predict_and_score()






# ## W2V + BLSTM Granular
print('Starting PCA script for W2V & BLSTM granular ids for 60 epochs...')
RANDOMSEED = 1099
CLASS_TYPE = '157Granular_PCA'
MODEL_TYPE = 'blstm'
VECTOR_TRANSFORMER='w2v'
OPTIMIZER = 'adam' 
LAYERS = 2
DROPOUT = 0.2 
BATCHSIZE = 64
EPOCHS = 60
vectorRootPath = os.path.join('data','DLvectors')
pca_vectors_train_path = os.path.join(vectorRootPath, 'PCA_train_157classes')
pca_vectors_test_path = os.path.join(vectorRootPath, 'PCA_test_157classes')
dlInputs = os.path.join('data', 'DLinputs')
pca_inputs_train_path = os.path.join(dlInputs,'PCA_train_157classes')
pca_inputs_test_path = os.path.join(dlInputs,'PCA_test_157classes')

checkpoint_dir = './ckpt_%s_%s_%s_%s' % (VECTOR_TRANSFORMER, MODEL_TYPE, str(BATCHSIZE), CLASS_TYPE)
model_name = '%s_%s_batch=%s_seed=%s_epochs=%s_%s' % (MODEL_TYPE.upper(), VECTOR_TRANSFORMER.upper(), BATCHSIZE, RANDOMSEED, EPOCHS, CLASS_TYPE)
metrics_path = os.path.join(f'{VECTOR_TRANSFORMER}Model', 'metrics', MODEL_TYPE)
weights_path = os.path.join('model', model_name + OPTIMIZER + str(RANDOMSEED))

dvt = DetectVulType(build_model=create_blstm_model, useGenerator=True, layers=LAYERS,
                    metricsPath=metrics_path, randomSeed=RANDOMSEED,
                    m_epochs=EPOCHS, batch_size=BATCHSIZE, modelName=model_name,
                    mask=False, dropout=DROPOUT, optimizer=OPTIMIZER,
                    vectorTrainPath=pca_vectors_train_path, vectorTestPath=pca_vectors_test_path, 
                    inputsTrainPath=pca_inputs_train_path, inputsTestPath=pca_inputs_test_path, 
                    checkpoint_dir=checkpoint_dir, weightpath=weights_path)
dvt.avg = 1
dvt.vector_size = VECTOR_SIZE
dvt.encodeLabels() # requires vectorTrainPath
print(f'Density units: {dvt.density_units}. Vector size: {dvt.vector_size}')
dvt.reset_check_weights(weights_path)
dvt.build_and_fit() # requires inputsTrainPath
dvt.predict_and_score()


