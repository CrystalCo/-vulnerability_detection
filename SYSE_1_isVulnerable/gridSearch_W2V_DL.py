import os, sys

import pandas as pd
import numpy as np
from sklearn.model_selection import GridSearchCV
from sklearn.pipeline import Pipeline

#### Setting variables
vType = "ALL"
randomSeed = 1099
numSamples = 50
slicePath = './data/slicesSource/'
tokenPath = './data/token/SARD/'
multiclasspath = './data/CVE/SARD_CVE_to_groups.csv'
vectorTrainPath = './data/DLvectors/train/'
vectorTestPath = './data/DLvectors/test/'
inputsTrainPath = './data/DLinputs/train/'
inputsTestPath = './data/DLinputs/test/'
VUL_PATH = os.environ.get('VUL_PATH') 
sys.path.insert(1, VUL_PATH)


#### Preprocessing
# print('TOKENIZING SLICES...')
# from SYSE_1_isVulnerable.slicesToTokens import tokenizeSlices_Multiclass
# testcase_ids, testcase_ids_per_group = tokenizeSlices_Multiclass(slicePath, tokenPath, multiclasspath, numSamples)

# print('\nSPLITTING INTO TRAINING/TESTING SETS...')
# from SYSE_1_isVulnerable.splitTrainTest import splitTrainTest
# splitTrainTest(vType, tokenPath, vectorTrainPath, vectorTestPath, randomSeed, split = 0.8 )

from utils.utils import num_classes
num_units = len(num_classes(vectorTrainPath))

from SYSE_1_isVulnerable.adjustVectorLen import meanLen
avg = meanLen(vectorTrainPath, vType)

# print('\nHOT ENCODING CATEGORICAL LABELS...')
# from SYSE_1_isVulnerable.saveKeyData import saveKeyDataMulticlass
# saveKeyDataMulticlass(vectorTrainPath, inputsTrainPath)
# saveKeyDataMulticlass(vectorTestPath, inputsTestPath)


#### Grid Search for best parameters on W2V & BGRU models
from utils.Word2VecModel import Word2VecModel
from utils.KerasClassifier import KerasClassifier
from utils.BGRUCustomModel import create_bgru_model, score

bgru_estimator = KerasClassifier(build_fn=create_bgru_model, verbose=3)
pipe = Pipeline([('word2vec', Word2VecModel()), ('bgru', bgru_estimator)])

param_grid = {
    'word2vec__alpha': [0.01],
    'word2vec__negative': [10],
    'word2vec__epochs': [1],
    'word2vec__sample': [0.001],
    'word2vec__seed': [1],
    'word2vec__window': [5],
    'word2vec__workers': [2],
    'word2vec__vector_size': [30],
    'bgru__maxlen': [avg],
    'bgru__units2': [num_units],
    'bgru__dropout': [0.1],
    'bgru__epochs': [15], 
    'bgru__batch_size':[32],
    'bgru__vector_dim':[30],
}
grid = GridSearchCV(estimator=pipe,
                    param_grid=param_grid,
                    cv=2,
                    scoring=score,
                    verbose=3)

print('\nGRID SEARCH ON TRAINING DATASET COMMENCING...')
from SYSE_2_vulnerabilityType.MLMethods import getDataset

data = getDataset(inputsTrainPath, False, randomSeed)
x_train = data[0]
y_train = data[-2]

fitted = grid.fit(x_train, y_train)

print('\nGRID SEARCH ON TRAINING DATASET COMPLETE. RESULTS:\n')
print("Best Parameters: {}\n".format(grid.best_params_))
print("Best accuracy: {}\n".format(grid.best_score_))
print("Finished.")
