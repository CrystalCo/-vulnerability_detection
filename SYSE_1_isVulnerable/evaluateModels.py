import pickle
import os
import numpy as np
import random
import tabulate
from tabulate import tabulate

def predictValueWithThreshold(threshold, DLOutputs, RealLabel):
    pred_value = []
    metricType = []
    samples = len(DLOutputs)
    for i in range (samples):
        if DLOutputs[i] >= threshold:#0.5
            pred_value.append(1)
            if RealLabel[i] == 1:
                metricType.append("TP")
            else:
                metricType.append("FP")
        else: 
            pred_value.append(0)
            if RealLabel[i] == 0:
                metricType.append("TN")
            else:
                metricType.append("FN")

    return pred_value, metricType

#Loop from threshold array
def combinedPredictions(thresdArray, data):
    mydata = data
    DLOutputs = mydata["DLOutput"] 
    RealLabel = mydata["RealLabel"] 
    recall = []
    precision = []
    specificity = []
    F1 = []
    Accuracy = []
    balanceAccuracy = []
    length = len(thresdArray)
    for i in range (length):
        threshold  = thresdArray[i]
        predStr = "Pred" + str(threshold)
        metricStr = "Metric" +  str(threshold)
        mydata[predStr], mydata[metricStr] = predictValueWithThreshold(threshold, DLOutputs, RealLabel)
        TN = len(mydata[mydata[metricStr] == 'TN'])
        FP = len(mydata[mydata[metricStr] == 'FP'])
        TP = len(mydata[mydata[metricStr] == 'TP'])
        FN = len(mydata[mydata[metricStr] == 'FN'])
        try:
            recall.append((TP)/(TP + FN))
        except ZeroDivisionError:
            recall.append(0)
        try:
            precision.append((TP)/(TP + FP))
        except ZeroDivisionError:
            precision.append(0)
        try:
            specificity.append((TN)/(TN + FP))
        except ZeroDivisionError:
            specificity.append(0)
        try:
            F1.append(2*((precision[i]*recall[i])/(precision[i]+recall[i])))
        except ZeroDivisionError:
            F1.append(0)
        try:
            Accuracy.append((TP + TN)/(TP + TN+FP + FN))
        except ZeroDivisionError:
            Accuracy.append(0)
        try:
            balanceAccuracy.append((recall[i]+specificity[i])/2)
        except ZeroDivisionError:
            balanceAccuracy.append(0)
        
    return mydata, recall, precision, specificity, F1, Accuracy, balanceAccuracy 

def generateMetricTabel(thresdArray, recall, precision, specificity, F1, Accuracy, balanceAccuracy):
    print ('Predicted Class')
    resArray = [[]]
    length = len(thresdArray)
    for i in range(length):
        resArray.append([thresdArray[i], recall[i], precision[i], specificity[i], F1[i], Accuracy[i],balanceAccuracy[i]])

    myTable  = tabulate(resArray, headers=['thresdArray', 'recall', 'precision', 'specificity' , 'F1', "Accuracy",'balanceAccuracy'], tablefmt='fancy_grid')
    return myTable

